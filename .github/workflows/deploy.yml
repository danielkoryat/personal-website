name: Deploy to Home Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    env:
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Stop and remove old containers
      run: |
        echo "ğŸ›‘ Stopping all existing application containers..."
        docker compose down --remove-orphans || true
    
    - name: Clean up unused Docker images
      run: |
        echo "ğŸ§¹ Cleaning up old Docker images..."
        docker image prune -f
    
    - name: Build and deploy the entire stack
      run: |
        echo "ğŸ”¨ Building and deploying all services..."
        docker compose up --build -d --remove-orphans
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        # Give the app a few seconds to become healthy before checking
        sleep 15 
        
        if docker compose ps | grep -q "Up"; then
          echo "âœ… All containers are running."
        else
          echo "âŒ Container startup failed. Checking logs..."
          docker compose logs
          exit 1
        fi

        if curl --fail http://localhost:8080/health > /dev/null 2>&1; then
          echo "âœ… Health check passed on localhost:8080."
        else
          echo "âŒ Health check on localhost:8080 failed. Checking logs..."
          docker compose logs nginx
          docker compose logs portfolio-blue
          exit 1
        fi
    
    - name: Show deployment info
      run: |
        echo "ğŸš€ Website deployed successfully!"
        echo "ğŸ“… Deployment time: $(date)"
        
        echo ""
        echo "ğŸ“Š Final Container Status:"
        docker compose ps
