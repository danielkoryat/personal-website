name: Deploy to Home Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    env:
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
    
    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v4
    
    - name: 2. Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: 3. Ensure Core Infrastructure is Running
      run: |
        echo "üåê Ensuring nginx and cloudflared are running..."
        # Only start if they're not already running - don't restart them
        docker compose up -d nginx cloudflared

    - name: 4. Determine Deployment Slots
      run: |
        if grep -q "server daniel-koryat-portfolio-green:3000 backup;" nginx.conf; then
          LIVE_SLOT="blue"
          DEPLOY_SLOT="green"
        else
          LIVE_SLOT="green"
          DEPLOY_SLOT="blue"
        fi
        echo "Live environment: ${LIVE_SLOT}"
        echo "Deploying to: ${DEPLOY_SLOT}"
        echo "LIVE_SLOT=${LIVE_SLOT}" >> $GITHUB_ENV
        echo "DEPLOY_SLOT=${DEPLOY_SLOT}" >> $GITHUB_ENV

    - name: 5. Clean Up Target Environment Only
      run: |
        echo "üßπ Cleaning up only the ${DEPLOY_SLOT} environment..."
        # Stop and remove only the target container, not nginx
        docker compose stop "portfolio-${{ env.DEPLOY_SLOT }}" || true
        docker compose rm -f "portfolio-${{ env.DEPLOY_SLOT }}" || true

    - name: 6. Build and Deploy New Version
      run: |
        echo "üî® Building the ${{ env.DEPLOY_SLOT }} container..."
        docker compose build --no-cache "portfolio-${{ env.DEPLOY_SLOT }}"
        
        echo "üöÄ Starting the ${{ env.DEPLOY_SLOT }} container..."
        docker compose up -d "portfolio-${{ env.DEPLOY_SLOT }}"

    - name: 7. Wait for New Environment to be Healthy
      run: |
        CONTAINER_NAME="daniel-koryat-portfolio-${{ env.DEPLOY_SLOT }}"
        SERVICE_NAME="portfolio-${{ env.DEPLOY_SLOT }}"
        echo "üîç Waiting for ${CONTAINER_NAME} to become healthy..."
        for i in {1..30}; do
          HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "starting")
          if [ "${HEALTH_STATUS}" == "healthy" ]; then
            echo "‚úÖ ${CONTAINER_NAME} is healthy!"
            exit 0
          fi
          echo "   - Waiting... (Status: ${HEALTH_STATUS})"
          sleep 10
        done
        echo "‚ùå ${CONTAINER_NAME} failed to become healthy. Aborting."
        docker compose logs ${SERVICE_NAME}
        exit 1

    - name: 8. Switch Traffic (Zero Downtime)
      run: |
        echo "üîÑ Switching traffic from ${{ env.LIVE_SLOT }} to ${{ env.DEPLOY_SLOT }}..."
        
        # Update nginx configuration
        sed -i "s/server daniel-koryat-portfolio-${{ env.LIVE_SLOT }}:3000;/server daniel-koryat-portfolio-${{ env.LIVE_SLOT }}:3000 backup;/" nginx.conf
        sed -i "s/server daniel-koryat-portfolio-${{ env.DEPLOY_SLOT }}:3000 backup;/server daniel-koryat-portfolio-${{ env.DEPLOY_SLOT }}:3000;/" nginx.conf

        # Graceful reload (zero downtime) - nginx stays running!
        echo "Performing graceful nginx reload..."
        docker compose exec nginx nginx -s reload
        echo "‚úÖ Traffic switched with zero downtime!"

    - name: 9. Clean Up Old Environment
      run: |
        echo "üõë Stopping the old ${{ env.LIVE_SLOT }} container..."
        docker compose stop "portfolio-${{ env.LIVE_SLOT }}"

    - name: 10. Show Final Status
      run: |
        echo "üéâ Zero-downtime deployment complete!"
        echo "üìä Container Status:"
        docker compose ps
