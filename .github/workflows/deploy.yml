name: Deploy to Home Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Setup SSL certificates
      run: |
        echo "🔐 Setting up SSL certificates..."
        chmod +x scripts/setup-ssl.sh
        ./scripts/setup-ssl.sh
        echo "✅ SSL certificates generated successfully!"
    
    - name: Stop existing containers
      run: |
        echo "🛑 Stopping existing containers..."
        docker compose down --remove-orphans || true
    
    - name: Clean up old images
      run: |
        echo "🧹 Cleaning up old images..."
        docker image prune -f
        docker system prune -f
    
    - name: Build and deploy application
      run: |
        echo "🔨 Building and deploying application..."
        docker compose up -d --build
        
        # Wait for containers to be healthy
        echo "⏳ Waiting for containers to be ready..."
        sleep 30
        
        # Check container health
        docker compose ps
    
    - name: Verify deployment
      run: |
        echo "🔍 Verifying deployment..."
        
        # Check if containers are running
        if docker compose ps | grep -q "Up"; then
          echo "✅ Containers are running successfully"
        else
          echo "❌ Container health check failed"
          docker compose logs
          exit 1
        fi
        
        # Test health endpoint
        if curl -f http://localhost/health > /dev/null 2>&1; then
          echo "✅ Health check passed"
        else
          echo "⚠️  Health check failed, but continuing..."
        fi
    
    - name: Show deployment info
      run: |
        echo "🚀 Website deployed successfully!"
        echo "📅 Deployment time: $(date)"
        echo "🌐 Access URLs:"
        echo "   - HTTP: http://$(hostname -I | awk '{print $1}'):80"
        echo "   - HTTPS: https://$(hostname -I | awk '{print $1}'):443"
        echo "   - Direct: http://$(hostname -I | awk '{print $1}'):8080"
        
        echo ""
        echo "📊 Container Status:"
        docker compose ps
        
        echo ""
        echo "📝 Recent logs:"
        docker compose logs --tail=20
