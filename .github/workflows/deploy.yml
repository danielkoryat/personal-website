name: Deploy to Home Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Setup SSL certificates
      run: |
        echo "ğŸ” Setting up SSL certificates..."
        chmod +x scripts/setup-ssl.sh
        ./scripts/setup-ssl.sh
        echo "âœ… SSL certificates generated successfully!"
    
    - name: Stop existing containers
      run: |
        echo "ğŸ›‘ Stopping existing containers..."
        docker compose down --remove-orphans || true
    
    - name: Clean up old images
      run: |
        echo "ğŸ§¹ Cleaning up old images..."
        docker image prune -f
        docker system prune -f
    
    - name: Build and deploy application
      run: |
        echo "ğŸ”¨ Building and deploying application..."
        docker compose up -d --build
        
        # Wait for containers to be healthy
        echo "â³ Waiting for containers to be ready..."
        sleep 30
        
        # Check container health
        docker compose ps
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Check if containers are running
        if docker compose ps | grep -q "Up"; then
          echo "âœ… Containers are running successfully"
        else
          echo "âŒ Container health check failed"
          docker compose logs
          exit 1
        fi
        
        # Test health endpoint
        if curl -f http://localhost/health > /dev/null 2>&1; then
          echo "âœ… Health check passed"
        else
          echo "âš ï¸  Health check failed, but continuing..."
        fi
    
    - name: Show deployment info
      run: |
        echo "ğŸš€ Website deployed successfully!"
        echo "ğŸ“… Deployment time: $(date)"
        echo "ğŸŒ Access URLs:"
        echo "   - HTTP: http://$(hostname -I | awk '{print $1}'):80"
        echo "   - HTTPS: https://$(hostname -I | awk '{print $1}'):443"
        echo "   - Direct: http://$(hostname -I | awk '{print $1}'):8080"
        
        echo ""
        echo "ğŸ“Š Container Status:"
        docker compose ps
        
        echo ""
        echo "ğŸ“ Recent logs:"
        docker compose logs --tail=20
