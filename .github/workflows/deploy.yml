name: Deploy to Home Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Stop and remove old containers
      run: |
        echo "🛑 Stopping all existing application containers..."
        docker compose down --remove-orphans || true
    
    - name: Clean up unused Docker images
      run: |
        echo "🧹 Cleaning up old Docker images..."
        docker image prune -f
    
    - name: Build and deploy application
      # This is the key change: Make the secret available as an environment variable
      env:
        CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        echo "🔨 Building and deploying the entire stack..."
        
        # Docker Compose will now have access to the $CLOUDFLARED_TOKEN variable
        docker compose up --build -d --remove-orphans
    
    - name: Verify deployment
      run: |
        echo "🔍 Verifying deployment..."
        if docker compose ps | grep -q "Up"; then
          echo "✅ All containers are running successfully."
        else
          echo "❌ Container startup failed. Check the logs."
          docker compose logs
          exit 1
        fi
        if curl --fail http://localhost:8080/health > /dev/null 2>&1; then
          echo "✅ Health check passed on localhost:8080."
        else
          echo "⚠️ Health check on localhost:8080 failed, but continuing..."
        fi
    
    - name: Show deployment info
      run: |
        echo "🚀 Website deployed successfully!"
        echo "📅 Deployment time: $(date)"
        echo "🌐 Your site is live and accessible via your Cloudflare domain."
        
        echo ""
        echo "📊 Final Container Status:"
        docker compose ps
