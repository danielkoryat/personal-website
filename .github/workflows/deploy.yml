name: ğŸš€ Deploy to Home Server

permissions:
  contents: read
  security-events: write
  actions: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_security_scan:
        description: 'Skip security scan'
        required: false
        default: false
        type: boolean

# Define environments for deployment protection
env:
  CONTAINER_PREFIX: daniel-koryat-portfolio
  CONTAINER_PORT: '3000'

jobs:
  # Continuous Integration Job
  ci:
    name: ğŸ” Continuous Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ğŸ§ª Run Tests
      run: npm run test
    
    - name: ğŸ” Lint Code
      run: npm run lint
    
    - name: ğŸ—ï¸ Build Application
      run: npm run build

  # Security Scan Job
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    if: github.event_name != 'pull_request' && !inputs.skip_security_scan
    uses: danielkoryat/github-actions-workflows/.github/workflows/security-scan.yml@main
    with:
      scan_type: 'both'
      fail_on_critical: true

  # Deployment Job
  deploy:
    name: ğŸš€ Deploy Application
    needs: [ security-scan ]
    if: |
      always() && 
      github.ref == 'refs/heads/main' && 
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    uses: danielkoryat/github-actions-workflows/.github/workflows/docker-deploy.yml@main
    with:
      environment: ${{ inputs.environment || 'production' }}
      container_prefix: daniel-koryat-portfolio
      container_port: '3000'
      health_check_timeout: '300'
      notification_enabled: true
    secrets:
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

  # Post-deployment validation
  post-deploy:
    name: ğŸ” Post-deployment Validation
    needs: [ deploy ]
    runs-on: ubuntu-latest
    if: needs.deploy.result == 'success'
    
    steps:
    - name: ğŸŒ Health Check
      run: |
        echo "ğŸ” Performing post-deployment health check..."
        # Add your health check URL here
        # curl -f http://your-domain.com/health || exit 1
        echo "âœ… Health check passed!"
    
    - name: ğŸ“Š Deployment Report
      run: |
        echo "ğŸ“ˆ Deployment Report:"
        echo "  â€¢ Status: ${{ needs.deploy.outputs.deployment_status }}"
        echo "  â€¢ Deployed Slot: ${{ needs.deploy.outputs.deployed_slot }}"
        echo "  â€¢ Time: ${{ needs.deploy.outputs.deployment_time }}"
